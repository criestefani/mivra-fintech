# Market Scanner Frontend Fix - Complete Solution

## Problem
The Market Scanner page shows "No high-confidence signals right now" and "0 Assets" even though signals are being generated by the market scanner backend and stored in the `strategy_trades` table in Supabase.

## Root Cause
The frontend fetches data from the `scanner_performance` table, but this table:
1. **Did not exist** in the Supabase database
2. **Was never populated** because there was no backend process to aggregate data from `strategy_trades`

---

## Solution: 4-Step Fix

### Step 1: Create Database Table

Run this SQL in Supabase SQL Editor:

```sql
CREATE TABLE IF NOT EXISTS scanner_performance (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  active_id VARCHAR NOT NULL,
  ativo_nome VARCHAR NOT NULL,
  timeframe INTEGER NOT NULL,
  total_signals INTEGER DEFAULT 0,
  total_wins INTEGER DEFAULT 0,
  total_losses INTEGER DEFAULT 0,
  win_rate NUMERIC(5,2) DEFAULT 0,
  last_updated TIMESTAMP DEFAULT NOW(),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(active_id, ativo_nome, timeframe)
);

CREATE INDEX idx_scanner_performance_win_rate ON scanner_performance(win_rate DESC);
CREATE INDEX idx_scanner_performance_signals ON scanner_performance(total_signals DESC);

ALTER TABLE scanner_performance ENABLE ROW LEVEL SECURITY;
CREATE POLICY "Allow public read" ON scanner_performance FOR SELECT TO public USING (true);
GRANT SELECT ON scanner_performance TO authenticated, anon;
```

### Step 2: Files Created

‚úÖ `apps/backend/src/services/scanner-aggregator.mjs` - Aggregates data from strategy_trades
‚úÖ `apps/backend/src/db/scanner-performance-init.mjs` - Table initialization
‚úÖ `database-schema-scanner-performance.sql` - SQL schema

### Step 3: Backend Updated

‚úÖ `apps/backend/src/api-server.mjs`:
- Added scanner-aggregator import
- Added POST `/api/scanner/aggregate` endpoint
- Added automatic aggregation every 30 seconds
- Added initial aggregation on startup

### Step 4: Restart & Verify

```bash
# Restart backend
npm start

# You should see:
# üîß Starting initial scanner data aggregation...
# ‚úÖ Initial aggregation complete: N records
```

---

## How It Works

```
Market Scanner Bot
    ‚Üì (inserts)
strategy_trades (WIN/LOSS)
    ‚Üì (every 30s)
Aggregator Service
    ‚Üì (groups by: active_id, ativo_nome, timeframe)
    ‚Üì (calculates: win_rate, total_signals)
scanner_performance
    ‚Üì (subscribed)
Frontend Hook
    ‚Üì
Market Scanner Page
    ‚Üì
Asset Cards (HeatmapGrid)
```

---

## Verification

### ‚úÖ Check Backend
```bash
# Trigger aggregation manually
curl -X POST http://localhost:4001/api/scanner/aggregate

# Get top 20 assets
curl http://localhost:4001/api/scanner/top20
```

### ‚úÖ Check Database
```sql
SELECT COUNT(*) FROM scanner_performance;
SELECT * FROM scanner_performance LIMIT 10;
```

### ‚úÖ Check Frontend
- Refresh Market Scanner page
- Should show asset cards instead of "No signals"

---

## API Endpoints

**POST /api/scanner/aggregate** - Manual aggregation
```bash
curl -X POST http://localhost:4001/api/scanner/aggregate
# Returns: { success, message, result }
```

**GET /api/scanner/top20** - Get top assets
```bash
curl http://localhost:4001/api/scanner/top20
# Returns: { success, data: [], count, timestamp }
```

---

## Troubleshooting

**Table doesn't exist?**
- Run the SQL schema script in Supabase SQL Editor

**No data showing?**
- Check: `SELECT COUNT(*) FROM strategy_trades WHERE result IN ('WIN','LOSS');`
- If 0: Market scanner hasn't generated trades yet
- If >0: Restart backend to trigger initial aggregation

**Wrong data?**
```sql
SELECT active_id, ativo_nome, COUNT(*) FROM scanner_performance GROUP BY 1,2;
```

---

## Summary

| What | Status | Action |
|------|--------|--------|
| Backend aggregator | ‚úÖ Added | Auto-runs every 30s |
| Database table | ‚ùì Needed | Run SQL script |
| API endpoint | ‚úÖ Added | Available for testing |
| Frontend code | ‚úÖ Working | No changes needed |

**Total time to fix**: 5 minutes (1 min SQL + 4 min restart)

